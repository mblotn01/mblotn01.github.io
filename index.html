<!DOCTYPE html>
<html>
  <head>
    <title>Marauder's Map</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?sensor=true">
    </script>
    <script type="text/javascript">
      function initialize() {
        var mapOptions = {
          center: { lat: 42.376, lng: -71.055},
          zoom: 9
        };
         map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);


      }
      google.maps.event.addDomListener(window, 'load', initialize);
     
      var map;

      function success(position) {
          var latitude = position.coords.latitude;
          var longitude = position.coords.longitude;
	  var params = "login=Lucky&lat="+latitude+"&lng="+longitude;
	  console.log("lat: "+latitude+"lon: "+longitude);
	  createMyMarker(latitude, longitude);
	  sendRequest(params);

      }
      function error() {
	  alert("Unable to retreive your location");
      }

      navigator.geolocation.getCurrentPosition(success, error);

      function sendRequest(params) {

      var xhr;
 
      xhr = new XMLHttpRequest();
      xhr.open("POST", "http://chickenofthesea.herokuapp.com/sendlocation", true);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
 
      xhr.onreadystatechange = function() {
          console.log("status: "+xhr.status);
          if(xhr.readyState == 4 && xhr.status == 200){
		document.getElementById("results").innerHTML = xhr.response;
		var dict = JSON.parse(xhr.response);
		var characters = dict["characters"];
		var students = dict["students"];

		var character;
		for(i = 0; i < characters.length; i++){
			character = characters[i];
			createCharacterMarker(character);
		}

		var student;
		for(i=0; i < students.length; i++){
			student = students[i];
			createStudentMarker(student);
		}

          }
      }
	
      xhr.send(params);
     }

     function createStudentMarker(student) {

	var studName = student["login"];
	var studTime = student["created_at"];
	var studLat = student["lat"];
	var studLon = student["lng"];

	var marker = new google.maps.Marker({

		position: { lat: studLat, lng: studLon}, 
		map: map,
		title: studName
			
        });

        var infoWindow = new google.maps.InfoWindow({

		content: "<p>"+studName+"</p>"+
			 "<p>Latitude: "+studLat+"</p>"+
			 "<p>Longitude: "+studLon+"</p>"+
			 "<p>Timestamp: "+studTime+"</p>"

	});

	google.maps.event.addListener(marker, 'click', function() {
    		infoWindow.open(map,marker);
        });

     }

     function createCharacterMarker(character) {

	var charName = character["name"];
	var charLoc = character["loc"];
	var charNote = charLoc["note"];
	var charLat = charLoc["latitude"];
	var charLon = charLoc["longitude"];
	var image;
	var realName;

	if(charName == "carmen"){
		realName = "Carmen Sandiego";
		image = "icons/carmen.png";
	}
	else if(charName == "nr"){
		realName = "Norman Ramsey";
		image = "icons/nr.png";
	}
	else if(charName == "waldo"){
		realName = "Waldo";
		image = "icons/waldo.png";
	}
	else if(charName == "snape"){
		realName = "Professor Severus Snape";
		image = "icons/snape.png";
	}
	else if(charName == "hescott"){
		realName = "Professor Ben Hescott";
		image = "icons/hescott.png";
	}
	else if(charName == "batman"){
		realName = "Batman";
		image = "icons/batman.png";
	}

	var marker = new google.maps.Marker({

		position: { lat: charLat, lng: charLon}, 
		map: map,
		title: charName,
		icon: image
			
        });

        var infoWindow = new google.maps.InfoWindow({

		content: "<p>"+realName+"</p>"+
			 "<p>Latitude: "+charLat+"</p>"+
			 "<p>Longitude: "+charLon+"</p>"+
			 "<p>Note: "+charNote+"</p>"

	});

	google.maps.event.addListener(marker, 'click', function() {
    		infoWindow.open(map,marker);
        });


     }

    function createMyMarker(myLat, myLon) {

	var image = 'icons/zac.jpg';
	var marker = new google.maps.Marker({

		position: { lat: myLat, lng: myLon}, 
		map: map,
		title: "Lucky",
		icon: image 
			
        });

	var infoWindow = new google.maps.InfoWindow({

		content: "<p>Lucky</p>"+
			 "<p>Latitude: "+myLat+"</p>"+
			 "<p>Longitude: "+myLon+"</p>"
	});

	google.maps.event.addListener(marker, 'click', function() {
    		infoWindow.open(map,marker);
        });

     }

      

    </script>

  </head>
  <body>
<div id="map-canvas"></div>

<p id="results"></p>
 
  </body>
</html>
